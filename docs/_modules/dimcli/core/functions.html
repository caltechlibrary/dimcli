

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dimcli.core.functions &mdash; DimCli  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> DimCli
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started with Dimcli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Module Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DimCli</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dimcli.core.functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dimcli.core.functions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Python wrappers for the DSL functions.</span>
<span class="sd">See also: https://docs.dimensions.ai/dsl/functions.html</span>
<span class="sd">NOTE: these objects are attached to the top level ``dimcli.functions`` module. So you can load them as follows:</span>

<span class="sd">&gt;&gt;&gt; from dimcli.functions import *</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">.api</span> <span class="kn">import</span> <span class="n">Dsl</span>
<span class="kn">from</span> <span class="nn">.auth</span> <span class="kn">import</span> <span class="n">is_logged_in</span>

<span class="kn">from</span> <span class="nn">..utils.utils_dimensions</span> <span class="kn">import</span> <span class="n">dsl_escape</span>


<div class="viewcode-block" id="extract_concepts"><a class="viewcode-back" href="../../../modules.html#dimcli.core.functions.extract_concepts">[docs]</a><span class="k">def</span> <span class="nf">extract_concepts</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">scores</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_df</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Python wrapper for the DSL function `extract_concepts`.</span>

<span class="sd">    Extract concepts from any text. Text input is processed and extracted concepts are returned as an array of strings ordered by their relevance. See also: https://docs.dimensions.ai/dsl/functions.html#function-extract-concepts</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    text : str</span>
<span class="sd">        The text paragraphs to extract concepts from. </span>
<span class="sd">    scores : bool, optional</span>
<span class="sd">        Return the concepts scores as well, by default True</span>
<span class="sd">    as_df : bool, optional</span>
<span class="sd">        Return results as a pandas dataframe (instead of JSON), by default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Dataframe or dimcli.DslDataset</span>
<span class="sd">        The list of concepts that have been extracted. </span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; from dimcli.functions import extract_concepts</span>
<span class="sd">    &gt;&gt;&gt; extract_concepts(&quot;The impact of solar rays on the moon is not trivial.&quot;)</span>
<span class="sd">    n	concept	relevance</span>
<span class="sd">    0	impact	0.070622</span>
<span class="sd">    1	rays	0.062369</span>
<span class="sd">    2	solar rays	0.022934</span>
<span class="sd">    3	Moon	0.013245</span>
<span class="sd">    &quot;&quot;&quot;</span>
     

    <span class="k">if</span> <span class="n">is_logged_in</span><span class="p">():</span>
        <span class="n">dsl</span> <span class="o">=</span> <span class="n">Dsl</span><span class="p">()</span>
        <span class="n">_score</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span> <span class="k">if</span> <span class="n">scores</span> <span class="k">else</span> <span class="s1">&#39;false&#39;</span>
        <span class="k">if</span> <span class="n">as_df</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;extract_concepts(&quot;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;, return_scores=</span><span class="si">{</span><span class="n">_score</span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_dataframe</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s2">&quot;concepts&quot;</span> <span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;extract_concepts(&quot;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;, return_scores=</span><span class="si">{</span><span class="n">_score</span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span><span class="p">)</span></div>




<div class="viewcode-block" id="extract_grants"><a class="viewcode-back" href="../../../modules.html#dimcli.core.functions.extract_grants">[docs]</a><span class="k">def</span> <span class="nf">extract_grants</span><span class="p">(</span><span class="n">grant_number</span><span class="p">,</span> <span class="n">fundref</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">funder_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Python wrapper for the DSL function `extract_grants`.</span>

<span class="sd">    Extract grant Dimensions ID from provided parameters. Grant number must be provided with either a fundref or a funder name as an argument. See also: https://docs.dimensions.ai/dsl/functions.html#function-extract-grants</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grant_number : str</span>
<span class="sd">        The grant number/ID</span>
<span class="sd">    fundref : str, optional</span>
<span class="sd">        Fundref name    </span>
<span class="sd">    funder_name : str, optional</span>
<span class="sd">        Funder name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dimcli.DslDataset</span>
<span class="sd">        A Dimcli wrapper object containing JSON data. </span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; from dimcli.functions import extract_grants</span>
<span class="sd">    &gt;&gt;&gt; extract_grants(&quot;R01HL117329&quot;,  fundref=&quot;100000050&quot;).json</span>
<span class="sd">    {&#39;grant_id&#39;: &#39;grant.2544064&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">is_logged_in</span><span class="p">():</span>
        <span class="n">dsl</span> <span class="o">=</span> <span class="n">Dsl</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fundref</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;extract_grants(grant_number=&quot;</span><span class="si">{</span><span class="n">grant_number</span><span class="si">}</span><span class="s2">&quot;, fundref=&quot;</span><span class="si">{</span><span class="n">fundref</span><span class="si">}</span><span class="s2">&quot;)&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;extract_grants(grant_number=&quot;</span><span class="si">{</span><span class="n">grant_number</span><span class="si">}</span><span class="s2">&quot;, funder_name=&quot;</span><span class="si">{</span><span class="n">funder_name</span><span class="si">}</span><span class="s2">&quot;)&quot;&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="extract_classification"><a class="viewcode-back" href="../../../modules.html#dimcli.core.functions.extract_classification">[docs]</a><span class="k">def</span> <span class="nf">extract_classification</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">abstract</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Python wrapper for the DSL function `classify`.</span>

<span class="sd">    This function retrieves suggested classifications codes for any text. See also: https://docs.dimensions.ai/dsl/functions.html#function-classify</span>

<span class="sd">    NOTE `system` must be the acronym of one of the supported classification systems:</span>

<span class="sd">    * Fields of Research (FOR)</span>
<span class="sd">    * Research, Condition, and Disease Categorization (RCDC)</span>
<span class="sd">    * Health Research Classification System Health Categories (HRCS_HC)</span>
<span class="sd">    * Health Research Classification System Research Activity Classifications (HRCS_RAC)</span>
<span class="sd">    * Health Research Areas (HRA)</span>
<span class="sd">    * Broad Research Areas (BRA)</span>
<span class="sd">    * ICRP Common Scientific Outline (ICRP_CSO)</span>
<span class="sd">    * ICRP Cancer Types (ICRP_CT)</span>
<span class="sd">    * Units of Assessment (UOA)</span>
<span class="sd">    * Sustainable Development Goals (SDG)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    title : str</span>
<span class="sd">        The title of the document to classify.</span>
<span class="sd">    abstract : str</span>
<span class="sd">        The abstract of the document to classify.</span>
<span class="sd">    system : str, optional</span>
<span class="sd">        The classification system to use. Either an acronym from the supported classification systems, or null. If no system is provided, all systems are attempted in sequence (one query per system).</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbose mode, by default True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dimcli.DslDataset</span>
<span class="sd">        A Dimcli wrapper object containing JSON data. </span>

<span class="sd">    Example</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from dimcli.functions import extract_classification</span>
<span class="sd">    &gt;&gt;&gt; title=&quot;Burnout and intentions to quit the practice among community pediatricians: associations with specific professional activities&quot;</span>
<span class="sd">    &gt;&gt;&gt; extract_classification(title, &quot;&quot;, &quot;FOR&quot;).json</span>
<span class="sd">    {&#39;FOR&#39;: [{&#39;id&#39;: &#39;3177&#39;, &#39;name&#39;: &#39;1117 Public Health and Health Services&#39;}]}</span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">classifications</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FOR&quot;</span><span class="p">,</span> <span class="s2">&quot;RCDC&quot;</span><span class="p">,</span> <span class="s2">&quot;HRCS_HC&quot;</span><span class="p">,</span> <span class="s2">&quot;HRCS_RAC&quot;</span><span class="p">,</span> <span class="s2">&quot;HRA&quot;</span><span class="p">,</span> <span class="s2">&quot;BRA&quot;</span><span class="p">,</span> <span class="s2">&quot;ICRP_CSO&quot;</span><span class="p">,</span> <span class="s2">&quot;ICRP_CT&quot;</span><span class="p">,</span> <span class="s2">&quot;UOA&quot;</span><span class="p">,</span> <span class="s2">&quot;SDG&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">is_logged_in</span><span class="p">():</span>
        <span class="n">dsl</span> <span class="o">=</span> <span class="n">Dsl</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">system</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dsl</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;classify(title=&quot;</span><span class="si">{</span><span class="n">dsl_escape</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;, </span>
<span class="s2">                                        abstract=&quot;</span><span class="si">{</span><span class="n">dsl_escape</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;, </span>
<span class="s2">                                        system=&quot;</span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s2">&quot;)&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;No system provided, using all known systems (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">classifications</span><span class="p">)</span><span class="si">}</span><span class="s2"> queries).&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="n">classifications</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;classify(title=&quot;</span><span class="si">{</span><span class="n">dsl_escape</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;, </span>
<span class="s2">                                        abstract=&quot;</span><span class="si">{</span><span class="n">dsl_escape</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;, </span>
<span class="s2">                                        system=&quot;</span><span class="si">{</span><span class="n">classifier</span><span class="si">}</span><span class="s2">&quot;)&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span>
                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d</span></div>




<div class="viewcode-block" id="extract_affiliations"><a class="viewcode-back" href="../../../modules.html#dimcli.core.functions.extract_affiliations">[docs]</a><span class="k">def</span> <span class="nf">extract_affiliations</span><span class="p">(</span><span class="n">affiliations</span><span class="p">,</span> <span class="n">as_json</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Python wrapper for the DSL function `extract_affiliations`. </span>

<span class="sd">    This function returns GRID affiliations either using structured or unstructured input. Up to 200 input objects are allowed per request. See also: https://docs.dimensions.ai/dsl/functions.html#function-extract-affiliations</span>

<span class="sd">    The input argument ``affiliations`` can be one of the following:</span>

<span class="sd">    * a string, representing a single **unstructured** &#39;affiliation&#39;, eg</span>

<span class="sd">         &quot;new york university&quot;</span>

<span class="sd">    * a list of strings, representing **unstructured** &#39;affiliations&#39;, eg</span>

<span class="sd">        [&quot;new york university&quot;, &quot;london college of surgeons&quot;]</span>

<span class="sd">    * a list of dictionaries of **unstructured** &#39;affiliations&#39; data, eg </span>
<span class="sd">        </span>
<span class="sd">        [{&quot;affiliation&quot;: &quot;london college&quot;}, {&quot;affiliation&quot;: &quot;new york university&quot;}]</span>
<span class="sd">    </span>
<span class="sd">    * a list of dictionaries of **structured** &#39;affiliations&#39; data, eg </span>

<span class="sd">        [{&quot;name&quot;:&quot;london college cambridge&quot;,</span>
<span class="sd">        &quot;city&quot;:&quot;&quot;,</span>
<span class="sd">        &quot;state&quot;:&quot;&quot;,</span>
<span class="sd">        &quot;country&quot;:&quot;&quot;},</span>
<span class="sd">        {&quot;name&quot;:&quot;milano bicocca&quot;,</span>
<span class="sd">        &quot;city&quot;:&quot;Milano&quot;,</span>
<span class="sd">        &quot;state&quot;:&quot;&quot;,</span>
<span class="sd">        &quot;country&quot;:&quot;Italy&quot;}</span>
<span class="sd">        ]</span>

<span class="sd">    By default, the JSON results are flattened and returned as a pandas dataframe.</span>

<span class="sd">    **NOTE** internally this function always uses the &#39;batch processing&#39; version of the API. The optional argument `results` is currently not supported (and hence defaults to &#39;basic&#39;).</span>

<span class="sd">    </span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    affiliations : str or list or dict</span>
<span class="sd">        The raw affiliation data to process. </span>
<span class="sd">    as_json : bool, optional</span>
<span class="sd">        Return raw JSON encoded as a Python dict (instead of a pandas dataframe, by default). </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame or dict </span>
<span class="sd">        A pandas dataframe containing a flattened representation of the JSON results. </span>

<span class="sd">    Example</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from dimcli.functions import extract_affiliations</span>
<span class="sd">    &gt;&gt;&gt; extract_affiliations(&quot;stanford medical center&quot;)</span>
<span class="sd">    n  affiliation_part        grid_id          grid_name grid_city  grid_state   grid_country  requires_review geo_country_id geo_country_name geo_country_code geo_state_id geo_state_name geo_state_code geo_city_id geo_city_name</span>
<span class="sd">    0  stanford medical center  grid.240952.8  Stanford Medicine  Stanford  California  United States             True        6252001    United States               US      5332921     California          US-CA     5398563      Stanford    </span>
<span class="sd">    &gt;&gt;&gt; data = [{&quot;affiliation&quot;: &quot;london college&quot;}, {&quot;affiliation&quot;: &quot;new york university&quot;}]</span>
<span class="sd">    &gt;&gt;&gt; extract_affiliations(data)</span>
<span class="sd">    n  affiliation_part        grid_id            grid_name grid_city grid_state    grid_country  requires_review geo_country_id geo_country_name geo_country_code geo_state_id geo_state_name geo_state_code geo_city_id  geo_city_name</span>
<span class="sd">    0  london college  grid.499389.6   The London College    London       None  United Kingdom             True        2635167   United Kingdom               GB      6269131        England           None     2643743         London</span>
<span class="sd">    1  new york university  grid.137628.9  New York University  New York   New York   United States            False        6252001    United States               US      5128638       New York          US-NY     5128581  New York City</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_logged_in</span><span class="p">():</span> <span class="k">return</span>
    <span class="n">dsl</span> <span class="o">=</span> <span class="n">Dsl</span><span class="p">()</span>
    <span class="n">affiliation_type</span> <span class="o">=</span> <span class="s2">&quot;UNSTRUCTURED&quot;</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">affiliations</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;affiliation&quot;</span><span class="p">:</span> <span class="n">affiliations</span><span class="p">}]</span>
    
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">affiliations</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">affiliations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;affiliation&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">affiliations</span><span class="p">]</span>
        
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">affiliations</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">affiliations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;affiliation&quot;</span> <span class="ow">in</span> <span class="n">affiliations</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="n">affiliations</span>
        <span class="k">elif</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">affiliations</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">affiliation_type</span> <span class="o">=</span> <span class="s2">&quot;STRUCTURED&quot;</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="n">affiliations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Dictionary is badly formatted. Cannot find &#39;affiliation&#39;, nor &#39;name&#39; keys. See https://docs.dimensions.ai/dsl/functions.html#function-extract-affiliations&quot;</span><span class="p">)</span>

    <span class="c1">#        </span>
    <span class="c1"># == main DSL query == </span>
    <span class="c1">#        </span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;extract_affiliations(json=</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span><span class="si">}</span><span class="s2">, results=&quot;basic&quot;)&quot;&quot;&quot;</span><span class="p">)</span>  <span class="c1"># same query for both struct and unstruct</span>
    
    <span class="k">if</span> <span class="n">as_json</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">json</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># return DF</span>
        <span class="k">if</span> <span class="n">affiliation_type</span> <span class="o">==</span> <span class="s2">&quot;STRUCTURED&quot;</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">],</span>  <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">affiliation_type</span> <span class="o">==</span> <span class="s2">&quot;UNSTRUCTURED&quot;</span><span class="p">:</span> 
            <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">],</span>  <span class="s1">&#39;matches&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;institutes&quot;</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;geo.countries&quot;</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;geo.states&quot;</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;geo.cities&quot;</span><span class="p">)</span>
        <span class="c1"># institutes fields</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;grid_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;institutes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;institute&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;grid_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;institutes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;institute&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;grid_city&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;institutes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;institute&#39;</span><span class="p">][</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;grid_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;institutes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;institute&#39;</span><span class="p">][</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;grid_country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;institutes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;institute&#39;</span><span class="p">][</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;requires_review&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;institutes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;requires_manual_review&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># geo fields - country</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo_country_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo.countries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;geonames_id&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo_country_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo.countries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo_country_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo.countries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># state</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo_state_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo.states&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;geonames_id&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo_state_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo.states&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo_state_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo.states&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># city</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo_city_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo.cities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;geonames_id&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo_city_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;geo.cities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># drop cols</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;institutes&#39;</span><span class="p">,</span> <span class="s1">&#39;geo.countries&#39;</span><span class="p">,</span> <span class="s1">&#39;geo.states&#39;</span><span class="p">,</span> <span class="s1">&#39;geo.cities&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">temp</span></div>





<span class="c1"># ===</span>
<span class="c1"># extract_affiliations sample raw outputs </span>
<span class="c1"># ===</span>


<span class="c1"># API OUTPUT for UNSTRUCTURED SEARCH</span>

<span class="c1"># {</span>
<span class="c1">#     &quot;results&quot;: [</span>
<span class="c1">#         {</span>
<span class="c1">#             &quot;matches&quot;: [</span>
<span class="c1">#                 {</span>
<span class="c1">#                     &quot;affiliation_part&quot;: &quot;london college cambridge&quot;,</span>
<span class="c1">#                     &quot;institutes&quot;: [</span>
<span class="c1">#                         {</span>
<span class="c1">#                             &quot;institute&quot;: {</span>
<span class="c1">#                                 &quot;id&quot;: &quot;grid.499389.6&quot;,</span>
<span class="c1">#                                 &quot;name&quot;: &quot;The London College&quot;,</span>
<span class="c1">#                                 &quot;city&quot;: &quot;London&quot;,</span>
<span class="c1">#                                 &quot;state&quot;: None,</span>
<span class="c1">#                                 &quot;country&quot;: &quot;United Kingdom&quot;</span>
<span class="c1">#                             },</span>
<span class="c1">#                             &quot;metadata&quot;: { &quot;requires_manual_review&quot;: True }</span>
<span class="c1">#                         }</span>
<span class="c1">#                     ],</span>
<span class="c1">#                     &quot;geo&quot;: {</span>
<span class="c1">#                         &quot;cities&quot;: [</span>
<span class="c1">#                             { &quot;geonames_id&quot;: 2643743, &quot;name&quot;: &quot;London&quot; }</span>
<span class="c1">#                         ],</span>
<span class="c1">#                         &quot;states&quot;: [</span>
<span class="c1">#                             {</span>
<span class="c1">#                                 &quot;geonames_id&quot;: 6269131,</span>
<span class="c1">#                                 &quot;name&quot;: &quot;England&quot;,</span>
<span class="c1">#                                 &quot;code&quot;: None</span>
<span class="c1">#                             }</span>
<span class="c1">#                         ],</span>
<span class="c1">#                         &quot;countries&quot;: [</span>
<span class="c1">#                             {</span>
<span class="c1">#                                 &quot;geonames_id&quot;: 2635167,</span>
<span class="c1">#                                 &quot;name&quot;: &quot;United Kingdom&quot;,</span>
<span class="c1">#                                 &quot;code&quot;: &quot;GB&quot;</span>
<span class="c1">#                             }</span>
<span class="c1">#                         ]</span>
<span class="c1">#                     }</span>
<span class="c1">#                 }</span>
<span class="c1">#             ],</span>
<span class="c1">#             &quot;input&quot;: { &quot;affiliation&quot;: &quot;london college cambridge&quot; }</span>
<span class="c1">#         }]</span>
<span class="c1"># }</span>

<span class="c1"># API OUTPUT for STRUCTURED SEARCH</span>

<span class="c1"># {</span>
<span class="c1">#     &quot;results&quot;: [</span>
<span class="c1">#         {</span>
<span class="c1">#             &quot;institutes&quot;: [</span>
<span class="c1">#                 {</span>
<span class="c1">#                     &quot;institute&quot;: {</span>
<span class="c1">#                         &quot;id&quot;: &quot;grid.499389.6&quot;,</span>
<span class="c1">#                         &quot;name&quot;: &quot;The London College&quot;,</span>
<span class="c1">#                         &quot;city&quot;: &quot;London&quot;,</span>
<span class="c1">#                         &quot;state&quot;: None,</span>
<span class="c1">#                         &quot;country&quot;: &quot;United Kingdom&quot;</span>
<span class="c1">#                     },</span>
<span class="c1">#                     &quot;metadata&quot;: { &quot;requires_manual_review&quot;: True }</span>
<span class="c1">#                 }</span>
<span class="c1">#             ],</span>
<span class="c1">#             &quot;geo&quot;: {</span>
<span class="c1">#                 &quot;cities&quot;: [{ &quot;geonames_id&quot;: 2643743, &quot;name&quot;: &quot;London&quot; }],</span>
<span class="c1">#                 &quot;states&quot;: [</span>
<span class="c1">#                     { &quot;geonames_id&quot;: 6269131, &quot;name&quot;: &quot;England&quot;, &quot;code&quot;: None }</span>
<span class="c1">#                 ],</span>
<span class="c1">#                 &quot;countries&quot;: [</span>
<span class="c1">#                     {</span>
<span class="c1">#                         &quot;geonames_id&quot;: 2635167,</span>
<span class="c1">#                         &quot;name&quot;: &quot;United Kingdom&quot;,</span>
<span class="c1">#                         &quot;code&quot;: &quot;GB&quot;</span>
<span class="c1">#                     }</span>
<span class="c1">#                 ]</span>
<span class="c1">#             },</span>
<span class="c1">#             &quot;input&quot;: {</span>
<span class="c1">#                 &quot;name&quot;: &quot;london college cambridge&quot;,</span>
<span class="c1">#                 &quot;city&quot;: &quot;&quot;,</span>
<span class="c1">#                 &quot;state&quot;: &quot;&quot;,</span>
<span class="c1">#                 &quot;country&quot;: &quot;&quot;</span>
<span class="c1">#             }</span>
<span class="c1">#         }</span>
<span class="c1">#     ]</span>
<span class="c1"># }</span>





<div class="viewcode-block" id="identify_experts"><a class="viewcode-back" href="../../../modules.html#dimcli.core.functions.identify_experts">[docs]</a><span class="k">def</span> <span class="nf">identify_experts</span><span class="p">(</span><span class="n">abstract</span><span class="p">,</span> <span class="n">max_concepts</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">connector</span><span class="o">=</span><span class="s2">&quot;OR&quot;</span><span class="p">,</span> <span class="n">conflicts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_dsl</span><span class="o">=</span><span class="s2">&quot;where year &gt;= 2010&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;publications&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Python wrapper for the expert identification workflow. See also https://docs.dimensions.ai/dsl/expert-identification.html</span>

<span class="sd">    This wrapper provide a simpler version of the expert identification API. It is meant to be a convenient alternative for basic queries. For more options, it is advised to use the API directly. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    abstract : str</span>
<span class="sd">        The abstract text used to identify experts. Concepts are automatically extracted from it.</span>
<span class="sd">    max_concepts : int, optional</span>
<span class="sd">        The maximum number of concepts to use for the identification. By default, this is 15. Concepts are ranked by relevance.</span>
<span class="sd">    connector : str, optional</span>
<span class="sd">        The logical connector used in the concepts query. Should be either &#39;AND&#39;, or &#39;OR&#39; (=default).</span>
<span class="sd">    conflicts : list, optional</span>
<span class="sd">        A list of Dimensions researchers IDs used to determine overlap / conflicts of interest.</span>
<span class="sd">    extra_dsl : str, optional</span>
<span class="sd">        A DSL clause to add after the main concepts search statement. Default is ``where year &gt;= 2010``.</span>
<span class="sd">    source : str, optional</span>
<span class="sd">        The DSL source to derive experts from. Either &#39;publications&#39; (default) or &#39;grants&#39;.  </span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbose mode, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Dataframe</span>
<span class="sd">        A dataframe containing experts details, including the dimensions URL of the experts. </span>

<span class="sd">    Example</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from dimcli.functions import identify_experts</span>
<span class="sd">    &gt;&gt;&gt; identify_experts(&quot;Moon landing paved the way for supercomputers becoming mainstream&quot;, verbose=True)</span>
<span class="sd">    Concepts extracted: 5</span>
<span class="sd">    Query:</span>
<span class="sd">    &quot;</span>
<span class="sd">    identify experts</span>
<span class="sd">        from concepts &quot;\&quot;landing\&quot; OR \&quot;way\&quot; OR \&quot;mainstream\&quot; OR \&quot;moon landing\&quot; OR \&quot;supercomputers\&quot;&quot;</span>
<span class="sd">        using publications where year &gt;= 2010</span>
<span class="sd">    return experts[all+dimensions_url-obsolete] </span>
<span class="sd">    &quot;</span>
<span class="sd">    Experts found: 20</span>
<span class="sd">    [..experts list..]</span>
<span class="sd">    &quot;&quot;&quot;</span>       

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_logged_in</span><span class="p">():</span> <span class="k">return</span>
    <span class="n">dsl</span> <span class="o">=</span> <span class="n">Dsl</span><span class="p">()</span>

    <span class="n">connector</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">connector</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AND&quot;</span><span class="p">,</span> <span class="s2">&quot;OR&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid connector: must be either &#39;AND&#39; or &#39;OR&#39;.&quot;</span><span class="p">)</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;publications&quot;</span><span class="p">,</span> <span class="s2">&quot;grants&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid source: must be either &#39;publications&#39; or &#39;grants&#39;.&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">extra_dsl</span><span class="o">==</span><span class="s2">&quot;where year &gt;= 2010&quot;</span> <span class="ow">and</span> <span class="n">source</span><span class="o">==</span><span class="s2">&quot;grants&quot;</span><span class="p">:</span>
        <span class="n">extra_dsl</span><span class="o">=</span><span class="s2">&quot;where start_year &gt;= 2010&quot;</span>

    <span class="n">conflicts_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">conflicts</span><span class="p">:</span>
        <span class="n">conflicts_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;annotate coauthorship, organizational overlap</span>
<span class="s2">            with </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">conflicts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
    
    <span class="c1"># get concepts</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">extract_concepts</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Concepts extracted: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">concepts_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">concept</span><span class="p">[:</span><span class="n">max_concepts</span><span class="p">]</span>
    <span class="n">concepts_list_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">connector</span><span class="si">}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">concepts_list</span><span class="p">])</span>
    
    
    <span class="c1"># get experts</span>
    <span class="n">thequery</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        identify experts</span>
<span class="s2">            from concepts &quot;</span><span class="si">{</span><span class="n">dsl_escape</span><span class="p">(</span><span class="n">concepts_list_query</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">            using </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">extra_dsl</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        return experts[all+dimensions_url-obsolete] </span><span class="si">{</span><span class="n">conflicts_query</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot;Query:</span><span class="se">\n</span><span class="s2">======&quot;</span> <span class="o">+</span> <span class="n">thequery</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">======&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">thequery</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;experts&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experts found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">experts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">as_dataframe</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span> <span class="p">[</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;dimensions_url&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;dimensions_url&#39;</span><span class="p">]</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experts found: 0&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>






<div class="viewcode-block" id="build_reviewers_matrix"><a class="viewcode-back" href="../../../modules.html#dimcli.core.functions.build_reviewers_matrix">[docs]</a><span class="k">def</span> <span class="nf">build_reviewers_matrix</span><span class="p">(</span><span class="n">abstracts</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">max_concepts</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">connector</span><span class="o">=</span><span class="s2">&quot;OR&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;publications&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a matrix of candidate reviewers for abstracts, using the expert identification workflow. See also https://docs.dimensions.ai/dsl/expert-identification.html</span>

<span class="sd">    If the input abstracts include identifiers, then those are used in the resulting matrix. </span>
<span class="sd">    Alternatively, a simple list of strings as input will result in a matrix where the identifiers are auto-generated from the abstracts order (first one is 1, etc..).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    abstracts : list</span>
<span class="sd">        The list of abstracts used for matching reviewers. Should be either a list of strings, or a list of dictionaries ``{&#39;id&#39; : &#39;{unique-ID}&#39;, &#39;text&#39; : &#39;{the-abstract}&#39;}`` including a unique identifier for each abstract.  </span>
<span class="sd">    candidates : list</span>
<span class="sd">        A list of Dimensions researchers IDs. </span>
<span class="sd">    max_concepts : int, optional</span>
<span class="sd">        The maximum number of concepts to use for the matching. By default, this is 15. Concepts are ranked by relevance.</span>
<span class="sd">    connector : str, optional</span>
<span class="sd">        The logical connector used in the concepts query. Should be either &#39;AND&#39;, or &#39;OR&#39; (=default).</span>
<span class="sd">    source : str, optional</span>
<span class="sd">        The DSL source to derive experts from. Either &#39;publications&#39; (default) or &#39;grants&#39;.  </span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbose mode, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Dataframe</span>
<span class="sd">        A dataframe containing experts details, including the dimensions URL of the experts. </span>

<span class="sd">    Example</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from dimcli.functions import build_reviewers_matrix</span>
<span class="sd">    &gt;&gt;&gt; abstracts = [</span>
<span class="sd">    ...:     {</span>
<span class="sd">    ...:     &#39;id&#39; : &#39;A1&#39;,</span>
<span class="sd">    ...:     &#39;text&#39; : We describe monocrystalline graphitic films, which are a few atoms thick but are nonetheless stable under ambient conditions,</span>
<span class="sd">    ...: metallic, and of remarkably high quality. The films are found to be a two-dimensional semimetal with a tiny overlap between</span>
<span class="sd">    ...: valence and conductance bands, and they exhibit a strong ambipolar electric field effect such that electrons and</span>
<span class="sd">    ...: holes in concentrations up to 10 per square centimeter and with room-temperature mobilities of approximately 10,000 square</span>
<span class="sd">    ...: centimeters per volt-second can be induced by applying gate voltage.&quot;</span>
<span class="sd">    ...:     },</span>
<span class="sd">    ...:     {</span>
<span class="sd">    ...:     &#39;id&#39; : &quot;A2&quot;,</span>
<span class="sd">    ...:     &#39;text&#39; : &quot;&quot;The physicochemical properties of a molecule-metal interface, in principle, can play a significant role in tuning the electronic properties</span>
<span class="sd">    ...: of organic devices. In this report, we demonstrate an electrode engineering approach in a robust, reproducible molecular memristor that</span>
<span class="sd">    ...: enables a colossal tunability in both switching voltage (from 130 mV to 4 V i.e. &gt;2500% variation) and current (by ~6 orders of magnitude).</span>
<span class="sd">    ...: This provides a spectrum of device design parameters that can be “dialed-in” to create fast, scalable and ultralow energy organic</span>
<span class="sd">    ...: memristors optimal for applications spanning digital memory, logic circuits and brain-inspired computing.&quot;</span>
<span class="sd">    ...:     }</span>
<span class="sd">    ...: ]</span>
<span class="sd">    ...:</span>
<span class="sd">    &gt;&gt;&gt; candidates = [&quot;ur.01146544531.57&quot;, &quot;ur.011535264111.51&quot;, &quot;ur.0767105504.29&quot;,</span>
<span class="sd">    ...:               &quot;ur.011513332561.53&quot;, &quot;ur.01055006635.53&quot;]</span>
<span class="sd">    &gt;&gt;&gt; build_reviewers_matrix(abstracts, candidates)</span>
<span class="sd">               researcher         A1        A2</span>
<span class="sd">    0   ur.01146544531.57   8.185277  0.000000</span>
<span class="sd">    1  ur.011535264111.51   8.203130  0.000000</span>
<span class="sd">    2    ur.0767105504.29   8.686363  2.626348</span>
<span class="sd">    3  ur.011513332561.53  12.920304  1.551920</span>
<span class="sd">    4   ur.01055006635.53   6.756862  1.797738</span>
<span class="sd">    &quot;&quot;&quot;</span>    


    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">abstracts</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">abstracts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span> <span class="p">:</span> <span class="n">y</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">abstracts</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">abstracts</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">abstracts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">abstracts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid abstracts data: must be either a list of strings, or a list of dictionaries.&quot;</span><span class="p">)</span> 


    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ur.&quot;</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid candidates data: must be a list of Dimensions researchers IDs.&quot;</span><span class="p">)</span> 

    
    <span class="c1"># boostrap matrix table</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;researcher&quot;</span><span class="p">])</span>
    <span class="n">matrix</span><span class="p">[</span><span class="s2">&quot;researcher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span>

    <span class="c1"># helper method: get score from candidates dataframe </span>
    <span class="k">def</span> <span class="nf">_get_score</span><span class="p">(</span><span class="n">experts_df</span><span class="p">,</span> <span class="n">resid</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">experts_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;id==&#39;</span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># finally..</span>
    <span class="k">for</span> <span class="n">abstract</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">abstracts</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">identify_experts</span><span class="p">(</span><span class="n">abstract</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> 
                                   <span class="n">max_concepts</span> <span class="o">=</span> <span class="n">max_concepts</span><span class="p">,</span>
                                   <span class="n">connector</span> <span class="o">=</span> <span class="n">connector</span><span class="p">,</span>
                                   <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                                   <span class="n">extra_dsl</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;where researchers in </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                                   <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">abstract</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="s2">&quot;researcher&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_get_score</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matrix</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Digital Science

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>