<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dimcli.core.api &mdash; DimCli  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> DimCli
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started with Dimcli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Modules Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DimCli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>dimcli.core.api</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dimcli.core.api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Dimcli objects for querying the Dimensions API. </span>
<span class="sd">NOTE: these objects are attached to the top level ``dimcli`` module. So you can load them as follows:</span>

<span class="sd">&gt;&gt;&gt; import dimcli</span>
<span class="sd">&gt;&gt;&gt; dsl = dimcli.Dsl()</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">IPython.display</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">.auth</span> <span class="kn">import</span> <span class="n">get_global_connection</span> 
<span class="kn">from</span> <span class="nn">.dsl_grammar</span> <span class="kn">import</span> <span class="n">G</span>
<span class="kn">from</span> <span class="nn">.dataframe_factory</span> <span class="kn">import</span> <span class="n">DfFactory</span>

<span class="kn">from</span> <span class="nn">..utils.all</span> <span class="kn">import</span> <span class="o">*</span>



<div class="viewcode-block" id="Dsl"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.Dsl">[docs]</a><span class="k">class</span> <span class="nc">Dsl</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;The Dsl object is the main interface for interacting with the Dimensions API.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    show_results : bool, default=False</span>
<span class="sd">        Set a global setting that determines whether query JSON results get printed out. Note that in Jupyter environments this is not needed, because iPython rich widgets are used by default.</span>
<span class="sd">    auth_session : APISession, default=False</span>
<span class="sd">        Set an authenticated session object that should be used for querying. Used only in special situations, as an alternative to the dimcli.login() utility method. </span>
<span class="sd">    verbose : bool, default=True</span>
<span class="sd">        Verbose mode.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import dimcli</span>
<span class="sd">    &gt;&gt;&gt; dimcli.login()</span>
<span class="sd">    &gt;&gt;&gt; dsl = dimcli.Dsl()</span>
<span class="sd">    &gt;&gt;&gt; dsl.query(\&quot;\&quot;&quot;search grants for &quot;graphene&quot; return researchers&quot;\&quot;\&quot;)</span>
<span class="sd">    &lt;dimcli.dimensions.DslDataset object&gt;</span>
<span class="sd">    &gt;&gt;&gt; _.json</span>
<span class="sd">    &gt;&gt;&gt; {&#39;researchers&#39;: [{&#39;id&#39;: &#39;ur.01332073522.49&#39;,</span>
<span class="sd">            &#39;count&#39;: 75,</span>
<span class="sd">            &#39;last_name&#39;: &#39;White&#39;,</span>
<span class="sd">            &#39;first_name&#39;: &#39;Nicholas J&#39;},</span>
<span class="sd">        &quot;... JSON data continues ... &quot;</span>

<span class="sd">    In some special situations, you&#39;d want to query two separate Dimensions servers </span>
<span class="sd">    in parallel. To that end, it is possible to pass an `APISession` instance to the `Dsl()` constructor</span>
<span class="sd">    using the `auth_session` parameter, IE:</span>

<span class="sd">    &gt;&gt;&gt; import dimcli</span>
<span class="sd">    &gt;&gt;&gt; from dimcli.core.auth import APISession </span>
<span class="sd">    # set up first authentication backend</span>
<span class="sd">    &gt;&gt;&gt; mysession1 = APISession()</span>
<span class="sd">    &gt;&gt;&gt; mysession1.login(instance=&quot;app.dimensions.ai&quot;)</span>
<span class="sd">    &gt;&gt;&gt; d1 = Dsl(auth_session=mysession1)</span>
<span class="sd">    &gt;&gt;&gt; d1.query(&quot;search publications return research_orgs&quot;)</span>
<span class="sd">    # set up second authentication backend</span>
<span class="sd">    &gt;&gt;&gt; mysession2 = APISession()</span>
<span class="sd">    &gt;&gt;&gt; mysession2.login(instance=&quot;another-app.dimensions.ai&quot;)</span>
<span class="sd">    &gt;&gt;&gt; d2 = Dsl(auth_session=mysession2)</span>
<span class="sd">    &gt;&gt;&gt; d2.query(&quot;search publications return research_orgs&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth_session</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialises a Dsl object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_results</span> <span class="o">=</span> <span class="n">show_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_ssl</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">auth_session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span> <span class="o">=</span> <span class="n">auth_session</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span> <span class="o">=</span> <span class="n">get_global_connection</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
            <span class="c1"># if already logged in, reuse connection          </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="o">.</span><span class="n">url</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s2">&quot;JWT &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_ssl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="o">.</span><span class="n">verify_ssl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_please_login</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_logged_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_print_please_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">printDebug</span><span class="p">(</span><span class="s2">&quot;Warning: you are not logged in. Please use `dimcli.login(key, endpoint)` before querying.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_refresh_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="o">.</span><span class="n">refresh_login</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="o">.</span><span class="n">url</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s2">&quot;JWT &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_ssl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONNECTION</span><span class="o">.</span><span class="n">verify_ssl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printDebug</span><span class="p">(</span><span class="s2">&quot;Warning: please login first.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Dsl.query"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.Dsl.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a single DSL query.</span>

<span class="sd">        This method handles the query token from the API and regenerates it if it&#39;s expired. If the API throws a &#39;Too Many Requests for the Server&#39; error, the method sleeps 30 seconds before retrying.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_results : bool, default=None</span>
<span class="sd">            Setting that determines whether the query JSON results should be printed out. If None, it inherits from the Dsl global setting. Note that in Jupyter environments this is not needed, because iPython rich widgets are used by default.</span>
<span class="sd">        retry : int, default=0</span>
<span class="sd">            Number of times to retry the query if it fails.</span>
<span class="sd">        verbose : bool, default=None</span>
<span class="sd">            Verbose mode. If None, it inherits from the Dsl global setting. </span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data. </span>

<span class="sd">        Example</span>
<span class="sd">        -------------</span>
<span class="sd">        &gt;&gt;&gt; dsl = dimcli.Dsl()</span>
<span class="sd">        &gt;&gt;&gt; dsl.query(&quot;search grants where start_year=2020 return grants&quot;)</span>
<span class="sd">        &lt;dimcli.dimensions.DslDataset object&gt;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_please_login</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>
        
        <span class="c1">#   Execute DSL query.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_ssl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>  
            <span class="c1"># Too Many Requests</span>
            <span class="n">printDebug</span><span class="p">(</span>
                <span class="s1">&#39;Too Many Requests for the Server. Sleeping for 30 seconds and then retrying.&#39;</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>  
            <span class="c1"># Forbidden:</span>
            <span class="n">printDebug</span><span class="p">(</span><span class="s1">&#39;Login token expired. Logging in again.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_login</span><span class="p">()</span>
            <span class="c1"># self._CONNECTION.refresh_login()</span>
            <span class="c1"># self._url = self._CONNECTION.url</span>
            <span class="c1"># self._headers = {&#39;Authorization&#39;: &quot;JWT &quot; + self._CONNECTION.token}</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">]:</span>  
            <span class="c1">###  </span>
            <span class="c1"># OK or Error Info :-)</span>
            <span class="c1">###</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">printDebug</span><span class="p">(</span><span class="s1">&#39;Unexpected error. JSON could not be parsed.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DslDataset</span><span class="p">(</span><span class="n">res_json</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">print_json_stats</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">)</span>
            <span class="n">print_json_errors</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="c1"># ALWAYS print errors</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">print_json_warnings</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="c1"># DON&#39;T print warnings unless verbose=True</span>
            <span class="k">if</span> <span class="n">show_results</span> <span class="ow">or</span> <span class="p">(</span><span class="n">show_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_results</span><span class="p">):</span>
                <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">printDebug</span><span class="p">(</span><span class="s1">&#39;Retrying in 30 secs&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="n">q</span><span class="p">,</span>
                    <span class="n">show_results</span><span class="p">,</span>
                    <span class="n">retry</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> 
                    <span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">printDebug</span><span class="p">(</span><span class="s2">&quot;ERROR LOG</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">Query</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">printDebug</span><span class="p">(</span><span class="s2">&quot;Response.header</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">printDebug</span><span class="p">(</span><span class="s2">&quot;Response.content</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">),</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span></div>



<div class="viewcode-block" id="Dsl.query_iterative"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.Dsl.query_iterative">[docs]</a>    <span class="k">def</span> <span class="nf">query_iterative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pause</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxlimit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_tot_count_prev_query</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_warnings_tot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>       
        <span class="sd">&quot;&quot;&quot;Runs a DSL query and then keep querying until all matching records have been extracted. </span>
<span class="sd">        </span>
<span class="sd">        The API returns a maximum of 1000 records per call. If a DSL query results in more than 1000 matches, it is possible to use pagination to get more results, up to 50k. </span>
<span class="sd">        </span>
<span class="sd">        Iterative querying works by automatically paginating through all records available for a result set. The original query gets turned into a loop that uses the `limit` / `skip` operators until all the results available have been extracted. </span>

<span class="sd">        NOTE If any of the iterative queries produce warning messages, these are aggregated and added to the `_warnings`section of the output data.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q: str </span>
<span class="sd">            The DSL query. Important: pagination keywords eg `limit` / `skip` should be omitted.</span>
<span class="sd">        show_results : bool, default=True</span>
<span class="sd">            Determines whether the final results are rendered via the iPython display widget (for Jupyter notebooks).</span>
<span class="sd">        limit : int, default=1000</span>
<span class="sd">            How many records to extract per iteration. Defaults to 1000.</span>
<span class="sd">        skip : int, default=0</span>
<span class="sd">            Offset for first iteration. Defaults to 0. After the first iteration, this value is calculated dynamically.</span>
<span class="sd">        pause : float, default=1.5s</span>
<span class="sd">            How much time to pause after each iterarion, expressed in seconds. Defaults to 1.5. Note: each iteration gets timed, so the pause time is used only when the query time is more than 2s. </span>
<span class="sd">        force : bool, default=False</span>
<span class="sd">            Continue the extraction even if one of the iterations fails due to an error. </span>
<span class="sd">        maxlimit : int, default=0</span>
<span class="sd">            The maximum number of records to extract in total. If 0, all available records are extracted, up to the API upper limit of 50k records per query.</span>
<span class="sd">        verbose : bool, default=False</span>
<span class="sd">            Verbose mode.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data. </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; dsl = dimcli.Dsl()</span>
<span class="sd">        &gt;&gt;&gt; dsl.query_iterative(\&quot;\&quot;&quot;search grants where category_for.name=&quot;0206 Quantum Physics&quot; return grants&quot;\&quot;\&quot;)</span>
<span class="sd">        Starting iteration with limit=1000 skip=0 ...</span>
<span class="sd">        0-1000 / 8163 (4.062144994735718s)</span>
<span class="sd">        1000-2000 / 8163 (1.5146172046661377s)</span>
<span class="sd">        2000-3000 / 8163 (1.7225260734558105s)</span>
<span class="sd">        3000-4000 / 8163 (1.575329065322876s)</span>
<span class="sd">        4000-5000 / 8163 (1.521540880203247s)</span>
<span class="sd">        5000-6000 / 8163 (1.471721887588501s)</span>
<span class="sd">        6000-7000 / 8163 (1.5068159103393555s)</span>
<span class="sd">        7000-8000 / 8163 (1.4724757671356201s)</span>
<span class="sd">        8000-8163 / 8163 (0.7611980438232422s)</span>
<span class="sd">        ===</span>
<span class="sd">        Records extracted: 8163</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_please_login</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>

        <span class="k">if</span> <span class="n">line_count_returns</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Iterative queries support only 1 return statement&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line_has_limit_or_skip</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Iterative queries should not contain the keywords `limit` or `skip`&quot;</span><span class="p">)</span>
        <span class="n">sourcetype</span> <span class="o">=</span> <span class="n">line_search_return</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>  
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sourcetype</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">sources</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Iterative queries can return only one of the Dimensions sources: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">sources</span><span class="p">()]))</span> 

        <span class="n">IS_UNNEST</span> <span class="o">=</span> <span class="n">line_search_unnest</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># ensure we stop the loop at 50k **</span>
        <span class="c1">#</span>
        <span class="n">MAXLIMIT</span> <span class="o">=</span> <span class="n">maxlimit</span> <span class="ow">or</span> <span class="mi">50000</span>
        <span class="n">flag_last_round</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">skip</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">&gt;=</span> <span class="n">MAXLIMIT</span><span class="p">:</span>
            <span class="n">flag_last_round</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">skip</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="n">MAXLIMIT</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="n">MAXLIMIT</span> <span class="o">-</span> <span class="n">skip</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">_tot_count_prev_query</span><span class="p">:</span>
            <span class="c1"># first iteration</span>
            <span class="c1"># if verbose: printDebug(f&quot;{limit+skip} / ...&quot;)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">printDebug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting iteration with limit=</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> skip=</span><span class="si">{</span><span class="n">skip</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
            
        <span class="n">output</span><span class="p">,</span> <span class="n">flag_force</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">False</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s2">&quot; limit </span><span class="si">%d</span><span class="s2"> skip </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="n">show_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># printDebug(&quot;sleeping&quot;)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">printDebug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt;[Dimcli tip] An error occurred with the batch &#39;</span><span class="si">{</span><span class="n">skip</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">limit</span><span class="o">+</span><span class="n">skip</span><span class="si">}</span><span class="s2">&#39;. Consider using the &#39;limit&#39; argument to retrieve fewer records per iteration, or use &#39;force=True&#39; to ignore errors and continue the extraction.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">elif</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">printDebug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt;[Dimcli log] An error occurred with the batch &#39;</span><span class="si">{</span><span class="n">skip</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">limit</span><span class="o">+</span><span class="n">skip</span><span class="si">}</span><span class="s2">&#39;. Skipping this batch and continuing iteration.. &quot;</span><span class="p">)</span>
            <span class="n">flag_force</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># RECURSION </span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">][</span><span class="s1">&#39;total_count&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">tot</span> <span class="o">=</span>  <span class="n">_tot_count_prev_query</span> <span class="c1"># when force=True, we have no current query stats</span>

        <span class="n">new_skip</span> <span class="o">=</span> <span class="n">skip</span><span class="o">+</span><span class="n">limit</span>
        <span class="k">if</span> <span class="n">tot</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new_skip</span> <span class="o">&gt;</span> <span class="n">tot</span><span class="p">:</span>
            <span class="n">new_skip</span> <span class="o">=</span> <span class="n">tot</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">tot</span><span class="p">:</span>  <span class="c1"># if not first iteration</span>
            <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">elapsed</span>
            <span class="n">printDebug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">skip</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">new_skip</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">tot</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;_warnings&quot;</span><span class="p">]:</span>
            <span class="n">warnings</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> (iteration: </span><span class="si">{</span><span class="n">skip</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">new_skip</span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;_warnings&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">_warnings_tot</span><span class="p">:</span>
                <span class="n">_warnings_tot</span> <span class="o">+=</span> <span class="n">warnings</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_warnings_tot</span> <span class="o">=</span> <span class="n">warnings</span>

        <span class="k">if</span> <span class="n">flag_force</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_iterative</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">new_skip</span><span class="p">,</span> <span class="n">pause</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">maxlimit</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">_tot_count_prev_query</span><span class="p">,</span> <span class="n">_warnings_tot</span><span class="p">)</span>                    

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">IS_UNNEST</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">])</span> <span class="o">==</span> <span class="n">limit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag_last_round</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_iterative</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">new_skip</span><span class="p">,</span> <span class="n">pause</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span><span class="n">maxlimit</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">tot</span><span class="p">,</span> <span class="n">_warnings_tot</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">IS_UNNEST</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag_last_round</span><span class="p">:</span>
            <span class="c1"># unnest returns a number of records that don&#39;t relate to actual data left</span>
            <span class="c1"># hence can&#39;t match the lenght of results to limit in this case</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_iterative</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">show_results</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">new_skip</span><span class="p">,</span> <span class="n">pause</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">maxlimit</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">tot</span><span class="p">,</span> <span class="n">_warnings_tot</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]</span>

        <span class="c1"># FINALLY </span>
        <span class="c1">#</span>
        <span class="c1"># if recursion is complete (we are at top level, hence skip=0) </span>
        <span class="c1">#   build the DslDataset obj</span>
        <span class="c1"># else </span>
        <span class="c1">#   just return current iteration results </span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">skip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">response_simulation</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;_stats&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="n">tot</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>  <span class="c1"># fallback..</span>
                    <span class="p">},</span>
                <span class="n">sourcetype</span><span class="p">:</span> <span class="n">output</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">_warnings_tot</span><span class="p">:</span>
                <span class="n">response_simulation</span><span class="p">[</span><span class="s2">&quot;_warnings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_warnings_tot</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DslDataset</span><span class="p">(</span><span class="n">response_simulation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_results</span> <span class="ow">or</span> <span class="p">(</span><span class="n">show_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_results</span><span class="p">):</span>
                <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="n">printDebug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;===</span><span class="se">\n</span><span class="s2">Records extracted: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_warnings_tot</span><span class="p">:</span> 
                    <span class="n">printDebug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warnings:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_warnings_tot</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;dimcli.Dsl #</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">. API endpoint: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="si">}</span><span class="s2">&gt;&quot;</span></div>



        

<div class="viewcode-block" id="DslDataset"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset">[docs]</a><span class="k">class</span> <span class="nc">DslDataset</span><span class="p">(</span><span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">JSON</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for JSON results from DSL.</span>

<span class="sd">    This object makes it easier to process, save and load API JSON data. </span>

<span class="sd">    Example</span>
<span class="sd">    ----------</span>
<span class="sd">    &gt;&gt;&gt; dsl = dimcli.Dsl()</span>
<span class="sd">    &gt;&gt;&gt; data = dsl.query(\&quot;\&quot;&quot;search publications for &quot;machine learning&quot; return publications limit 100&quot;\&quot;\&quot;)</span>
<span class="sd">    Returned Publications: 20 (total = 2501114)</span>
<span class="sd">    Time: 1.36s</span>
<span class="sd">    &gt;&gt;&gt; print(data)</span>
<span class="sd">    &lt;dimcli.DslDataset object #4383191536. Records: 100/2501114&gt;</span>
<span class="sd">    &gt;&gt;&gt; len(data)</span>
<span class="sd">    100</span>
<span class="sd">    &gt;&gt;&gt; data.count_batch</span>
<span class="sd">    100</span>
<span class="sd">    &gt;&gt;&gt; data.count_total</span>
<span class="sd">    2501114</span>
<span class="sd">    &gt;&gt;&gt; data.json</span>
<span class="sd">    #  =&gt; returns the underlying JSON data</span>
<span class="sd">    &gt;&gt;&gt; data[&#39;publications&#39;] </span>
<span class="sd">    #  =&gt; shortcut for the &#39;publications&#39; key in the underlying JSON data</span>
<span class="sd">    &gt;&gt;&gt; data.publications</span>
<span class="sd">    #  =&gt; ..this is valid too!</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DslDataset.from_publications_list"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.from_publications_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_publications_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method that allows to simulate an API results DslDataset object from raw publications data. </span>
<span class="sd">        </span>
<span class="sd">        This functionality can be used to reload data that was cached locally, or to combine the merged results of separate API queries into a single DslDataset object. </span>

<span class="sd">        Once created, the DslDataset object has the same exact behaviour as when it is obtained from an API query (so one can take advatange of dataframe creation methods, for example).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list or pandas dataframe </span>
<span class="sd">            A list of publications, in the form of either a list of dictionaries, or as a pandas dataframe. </span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data. </span>

<span class="sd">        Example</span>
<span class="sd">        ----------</span>
<span class="sd">        &gt;&gt;&gt; dsl = dimcli.Dsl()</span>
<span class="sd">        &gt;&gt;&gt; rawdata = dsl.query(&quot;search publications return publications&quot;).publications</span>
<span class="sd">        &gt;&gt;&gt; type(rawdata)</span>
<span class="sd">        list</span>
<span class="sd">        &gt;&gt;&gt; newDataset = dimcli.DslDataset.from_publications_list(rawdata)</span>
<span class="sd">        &gt;&gt;&gt; newDataset</span>
<span class="sd">        &lt;dimcli.DslDataset object #4767014816. Records: 20/20&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;publications&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DslDataset.from_grants_list"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.from_grants_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_grants_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method that allows to simulate an API results DslDataset object from raw grants data. See the `from_publications_list` method for more information. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list or pandas dataframe </span>
<span class="sd">            A grants list (using the API DSL structure), in the form of either a list of dictionaries, or as a pandas dataframe. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data.         </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;grants&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DslDataset.from_researchers_list"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.from_researchers_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_researchers_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method that allows to simulate an API results DslDataset object from raw researchers data. See the `from_publications_list` method for more information. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list or pandas dataframe </span>
<span class="sd">            A researchers list (using the API DSL structure), in the form of either a list of dictionaries, or as a pandas dataframe. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data.         </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;researchers&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DslDataset.from_clinical_trials_list"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.from_clinical_trials_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_clinical_trials_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method that allows to simulate an API results DslDataset object from raw clinical_trials data. See the `from_publications_list` method for more information. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list or pandas dataframe </span>
<span class="sd">            A clinical_trials list (using the API DSL structure), in the form of either a list of dictionaries, or as a pandas dataframe. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data.         </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;clinical_trials&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DslDataset.from_patents_list"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.from_patents_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_patents_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method that allows to simulate an API results DslDataset object from raw patents data. See the `from_publications_list` method for more information. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list or pandas dataframe </span>
<span class="sd">            A patents list (using the API DSL structure), in the form of either a list of dictionaries, or as a pandas dataframe. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data.         </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;patents&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DslDataset.from_policy_documents_list"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.from_policy_documents_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_policy_documents_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method that allows to simulate an API results DslDataset object from raw policy_documents data. See the `from_publications_list` method for more information. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list or pandas dataframe </span>
<span class="sd">            A policy_documents list (using the API DSL structure), in the form of either a list of dictionaries, or as a pandas dataframe. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data.         </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;policy_documents&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="DslDataset.from_organizations_list"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.from_organizations_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_organizations_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility method that allows to simulate an API results DslDataset object from raw organizations data. See the `from_publications_list` method for more information. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list or pandas dataframe </span>
<span class="sd">            An organizations list (using the API DSL structure), in the form of either a list of dictionaries, or as a pandas dataframe. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data.         </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_any_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;organizations&quot;</span><span class="p">)</span></div>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_any_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">source_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic method that allows to simulate an API results DslDataset object from raw data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">({</span><span class="n">source_type</span> <span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;_stats&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;total_count&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)}})</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">jsondata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">({</span><span class="n">source_type</span> <span class="p">:</span> <span class="n">jsondata</span><span class="p">,</span> <span class="s1">&#39;_stats&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;total_count&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">jsondata</span><span class="p">)}})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid data format. Must be either a dict list, or a pandas dataframe&#39;</span><span class="p">)</span>
    
<div class="viewcode-block" id="DslDataset.load_json_file"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.load_json_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_json_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a file containing DSL JSON data and returns a valid DslDataset object. </span>

<span class="sd">        Note: this is normally used in combination with the `to_json_file` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename: str </span>
<span class="sd">            A valid filename (including path if necessary) that contains the JSON data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DslDataset</span>
<span class="sd">            A Dimcli wrapper object containing JSON data.         </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        Save the results of a query to a JSON file, then reload the same file and create a new dataset.</span>

<span class="sd">        &gt;&gt;&gt; dataset = dsl.query(\&quot;\&quot;&quot;search publications where journal.title=&quot;nature medicine&quot; return publications[id+title+year+concepts] limit 100&quot;\&quot;\&quot;)</span>
<span class="sd">        Returned Publications: 100 (total = 12641)</span>

<span class="sd">        Save the data to a local json file</span>

<span class="sd">        &gt;&gt;&gt; FILENAME = &quot;test-api-save.json&quot;</span>
<span class="sd">        &gt;&gt;&gt; dataset.to_json_file(FILENAME, verbose=True)</span>
<span class="sd">        Saved to file:  test-api-save.json</span>
<span class="sd">        </span>
<span class="sd">        Create a new DslDataset object by loading the contents of the JSON file.</span>

<span class="sd">        &gt;&gt;&gt; new_dataset = DslDataset.load_json_file(FILENAME, verbose=True)</span>
<span class="sd">        Loaded file:  test-api-save.json</span>
<span class="sd">        &gt;&gt;&gt; print(new_dataset)</span>
<span class="sd">        &lt;dimcli.DslDataset object #4370267824. Records: 100/12641&gt;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">jsondata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">printDebug</span><span class="p">(</span><span class="s2">&quot;Loaded file: &quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">jsondata</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">JSON</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># add result dict keys as attributes dynamically</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;_stats&quot;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span> <span class="o">=</span> <span class="n">DfFactory</span><span class="p">(</span><span class="n">good_data_keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="s2">&quot;Trick to return any dict key as a property&quot;</span>
        <span class="c1"># printDebug(key, &quot;==========&quot;)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;stats&quot;</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;_stats&quot;</span> <span class="c1"># syntactic sugar</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span> <span class="c1"># empty list so to support iteration tests / previously: False</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Return length of first object in JSON&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="DslDataset.good_data_keys"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.good_data_keys">[docs]</a>    <span class="k">def</span> <span class="nf">good_data_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="sd">&quot;&quot;&quot;Utility that returns the &#39;data&#39; keys of the inner JSON object, excluding metadata like &#39;stats&#39;, &#39;warnings&#39; and &#39;version&#39; info. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of dictionary keys.         </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; queryresults.good_data_keys()</span>
<span class="sd">        [&#39;publications&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skips</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_warnings&quot;</span><span class="p">,</span> <span class="s2">&quot;_notes&quot;</span><span class="p">,</span> <span class="s2">&quot;_stats&quot;</span><span class="p">,</span> <span class="s2">&quot;_version&quot;</span><span class="p">,</span> <span class="s2">&quot;_copyright&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skips</span><span class="p">]</span></div>

<div class="viewcode-block" id="DslDataset.keys_and_count"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.keys_and_count">[docs]</a>    <span class="k">def</span> <span class="nf">keys_and_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="sd">&quot;&quot;&quot;Utility that previews the contents of the inner JSON object. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of tuples.       </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; queryresults.keys_and_count()</span>
<span class="sd">        [(&#39;_stats&#39;, 3), (&#39;_warnings&#39;, 1), (&#39;_version&#39;, 2), (&#39;publications&#39;, 100)]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="sd">&quot;&quot;&quot;Total number of results in Dimensions for the query (as opposed to the results returned in the JSON payload). </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The number of results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_stats&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;_stats&#39;</span><span class="p">][</span><span class="s1">&#39;total_count&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="sd">&quot;&quot;&quot;Number of results returned from the query. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The number of results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errors_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>  <span class="c1"># can&#39;t be called &#39;error&#39; due to conflict with auto-set field</span>
        <span class="sd">&quot;&quot;&quot;Utility that merges all errors messages into a single string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;details&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="DslDataset.chunks"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.chunks">[docs]</a>    <span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator for going through chunks of the JSON results. </span>

<span class="sd">        Note: in DSL queries with multiple `return` statements it is better to specify which result-type needs to be chunked using the `key` parameter. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        size: int, default=400 </span>
<span class="sd">            Number of objects (records) to include in each chunk.</span>
<span class="sd">        key: str, optional</span>
<span class="sd">            The JSON results data object that needs to be chunked eg &#39;publications&#39; or &#39;grants&#39;. If not specified, the first available dict key is used. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        iterator</span>
<span class="sd">            A iterator object         </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        Break up a 1000 records dataset into groups of 100.</span>

<span class="sd">        &gt;&gt;&gt; data = dslquery(&quot;search publications return publications limit 1000&quot;)</span>
<span class="sd">        &gt;&gt;&gt; groups = [len(x) for x in data.chunks(size=100)]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">printDebug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please specify a key from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">():</span>
            <span class="n">printDebug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid key: should be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> 

        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">chunk</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span></div>

    <span class="c1"># Dataframe Methods </span>

<div class="viewcode-block" id="DslDataset.as_dataframe"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.as_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nice</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the JSON data as a Pandas DataFrame. </span>

<span class="sd">        If `key` is empty, the first available JSON key (eg &#39;publications&#39;) is used to determine</span>
<span class="sd">        what JSON data should be turned into a dataframe (mostly relevant when using multi-result DSL queries).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key: str, optional</span>
<span class="sd">            The JSON results data object that needs to be processed.</span>
<span class="sd">        links: bool, optional </span>
<span class="sd">            Tranform suitable fields to hyperlinks. Default: False.</span>
<span class="sd">        nice: bool, optional </span>
<span class="sd">            Reformat column names and complex values where possible. Useful for visual inspection and printing our. Default: False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A DataFrame instance containing API records.   </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        See https://api-lab.dimensions.ai/cookbooks/1-getting-started/3-Working-with-dataframes.html        </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_simple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">nice</span><span class="p">)</span></div>


<div class="viewcode-block" id="DslDataset.as_dataframe_authors"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.as_dataframe_authors">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_authors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the JSON data as a Pandas DataFrame, in which each row corresponds to a publication author.</span>

<span class="sd">        This method works only with &#39;publications&#39; queries and it&#39;s clever enough to know if the `authors` or `author_affiliations` (deprecated) fields are used. The list of affiliations per each author are not broken down and are returned as JSON. So in essence you get one row per author.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A DataFrame instance containing API records.          </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        See https://api-lab.dimensions.ai/cookbooks/1-getting-started/3-Working-with-dataframes.html  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_authors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">links</span><span class="p">)</span></div>


<div class="viewcode-block" id="DslDataset.as_dataframe_authors_affiliations"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.as_dataframe_authors_affiliations">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_authors_affiliations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the JSON data as a Pandas DataFrame, in which each row corresponds to a publication affiliation.</span>

<span class="sd">        This method works only with &#39;publications&#39; queries and it&#39;s clever enough to know if the `authors` or `author_affiliations` (deprecated) fields are used. If an author has multiple affiliations, they would be represented in different rows (hence the same authors may appear on different rows). </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A DataFrame instance containing API records.          </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        See https://api-lab.dimensions.ai/cookbooks/1-getting-started/3-Working-with-dataframes.html  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_authors_affiliations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">links</span><span class="p">)</span></div>

<div class="viewcode-block" id="DslDataset.as_dataframe_concepts"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.as_dataframe_concepts">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_concepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the JSON data as a Pandas DataFrame, in which each row corresponds to a single &#39;concept&#39;.</span>

<span class="sd">        This method works only with &#39;publications&#39; and &#39;grants&#39; queries and it&#39;s clever enough to know if the `concepts` or `concepts_scores` fields are used. Additional metrics like &#39;frequency&#39; and &#39;score_average&#39; are also included in the results. </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A DataFrame instance containing API records.          </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        See https://api-lab.dimensions.ai/cookbooks/1-getting-started/3-Working-with-dataframes.html  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_concepts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">links</span><span class="p">)</span></div>


<div class="viewcode-block" id="DslDataset.as_dataframe_funders"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.as_dataframe_funders">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_funders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the JSON data as a Pandas DataFrame, in which each row corresponds to a single &#39;funder&#39;.</span>

<span class="sd">        This method works only with &#39;grants&#39; queries.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A DataFrame instance containing API records.          </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        See https://api-lab.dimensions.ai/cookbooks/1-getting-started/3-Working-with-dataframes.html  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_grant_funders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">links</span><span class="p">)</span></div>

<div class="viewcode-block" id="DslDataset.as_dataframe_investigators"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.as_dataframe_investigators">[docs]</a>    <span class="k">def</span> <span class="nf">as_dataframe_investigators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the JSON data as a Pandas DataFrame, in which each row corresponds to a single &#39;investigator&#39;.</span>

<span class="sd">        This method works only with &#39;grants&#39; queries.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A DataFrame instance containing API records.          </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        See https://api-lab.dimensions.ai/cookbooks/1-getting-started/3-Working-with-dataframes.html  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_factory</span><span class="o">.</span><span class="n">df_grant_investigators</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">links</span><span class="p">)</span></div>

<div class="viewcode-block" id="DslDataset.as_dimensions_url"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.as_dimensions_url">[docs]</a>    <span class="k">def</span> <span class="nf">as_dimensions_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility that turns a list of records into a Dimensions webapp URL, by using the record IDs as filters.</span>
<span class="sd">        </span>
<span class="sd">        NOTE: this functionality is EXPERIMENTAL and may break or be removed in future versions. Also, it works only with: publications, grants, patents, clinical_trials, policy_documents.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        records: int, default=500 </span>
<span class="sd">            The number of record IDs to use. With more than 500, it is likely to incur into a &#39;414 Request-URI Too Large&#39; error. </span>
<span class="sd">        verbose: bool, default=True</span>
<span class="sd">            Verbose mode</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            A string representing a Dimensions URL.  </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        &gt;&gt;&gt; data = dsl.query(\&quot;\&quot;&quot;search publications where id in [&quot;pub.1120715293&quot;, &quot;pub.1120975084&quot;, &quot;pub1122068834&quot;, &quot;pub.1120602308&quot;] return publications\&quot;\&quot;&quot;)</span>
<span class="sd">        &gt;&gt;&gt; data.as_dimensions_url()</span>
<span class="sd">        &#39;https://app.dimensions.ai/discover/publication?search_text=id%3A+%28pub.1120975084+OR+pub.1120715293+OR+pub.1120602308%29&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">printDebug</span><span class="p">(</span><span class="s2">&quot;Warning: this is an experimental and unsupported feature.&quot;</span><span class="p">)</span>


        <span class="c1"># General query structure for IDs: </span>
           
        <span class="c1"># `id: (pub.1120715293 OR pub.112097508 4 OR pub.1122068834 OR pub.1120602308)`</span>

        <span class="c1"># Final URL looks like this https://app.dimensions.ai/discover/publication?search_text=id%3A+%28pub.1120715293+OR+pub.1120975084+OR+pub.1122068834+OR+pub.1120602308%29</span>

        <span class="c1"># hardcoded</span>
        <span class="n">supported_url_templates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;publications&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/publication?search_text=&quot;</span><span class="p">,</span>
            <span class="s1">&#39;grants&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/grant?search_text=&quot;</span><span class="p">,</span>
            <span class="s1">&#39;patents&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/patent?search_text=&quot;</span><span class="p">,</span>
            <span class="s1">&#39;clinical_trials&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/clinical_trial?search_text=&quot;</span><span class="p">,</span>
            <span class="s1">&#39;policy_documents&#39;</span> <span class="p">:</span> <span class="s2">&quot;https://app.dimensions.ai/discover/policy_document?search_text=&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># just return first valid source found in results</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sourcetype</span> <span class="ow">in</span> <span class="n">supported_url_templates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sourcetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data_keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]]</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sourcetype</span> <span class="o">==</span> <span class="s2">&quot;grants&quot;</span><span class="p">:</span>
                        <span class="n">q</span> <span class="o">=</span>  <span class="s2">&quot;grant_id: (&quot;</span> <span class="o">+</span> <span class="n">q</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">q</span> <span class="o">=</span>  <span class="s2">&quot;id: (&quot;</span> <span class="o">+</span> <span class="n">q</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                    <span class="n">q</span> <span class="o">=</span>  <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">supported_url_templates</span><span class="p">[</span><span class="n">sourcetype</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;DslDataset records do not contain a valid ID field.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DslDataset.to_json_file"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.to_json_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export API results data to a JSON file. </span>

<span class="sd">        Note: this is normally used in combination with the `load_json_file` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename: str, optional </span>
<span class="sd">            A filename/path where to save the data. If not provided, a unique name is generated automatically.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The string representation of the filename the data is saved to.         </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        Save the results of a query to a JSON file, then reload the same file and create a new dataset.</span>

<span class="sd">        &gt;&gt;&gt; dataset = dsl.query(\&quot;\&quot;&quot;search publications where journal.title=&quot;nature medicine&quot; return publications[id+title+year+concepts] limit 100&quot;\&quot;\&quot;)</span>
<span class="sd">        Returned Publications: 100 (total = 12641)</span>

<span class="sd">        Save the data to a local json file</span>

<span class="sd">        &gt;&gt;&gt; FILENAME = &quot;test-api-save.json&quot;</span>
<span class="sd">        &gt;&gt;&gt; dataset.to_json_file(FILENAME, verbose=True)</span>
<span class="sd">        Saved to file:  test-api-save.json</span>
<span class="sd">        </span>
<span class="sd">        Data can be reloaded from file, using the `load_json_file` class method. </span>

<span class="sd">        &gt;&gt;&gt; new_dataset = DslDataset.load_json_file(FILENAME, verbose=True)</span>
<span class="sd">        Loaded file:  test-api-save.json</span>
<span class="sd">        &gt;&gt;&gt; print(new_dataset)</span>
<span class="sd">        &lt;dimcli.DslDataset object #4370267824. Records: 100/12641&gt;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dimensions_data_%Y-%m-%d_%H-%M-%S.json&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">printDebug</span><span class="p">(</span><span class="s2">&quot;Saved to file: &quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">filename</span></div>




<div class="viewcode-block" id="DslDataset.to_gsheets"><a class="viewcode-back" href="../../../modules.html#dimcli.core.api.DslDataset.to_gsheets">[docs]</a>    <span class="k">def</span> <span class="nf">to_gsheets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the dataframe version of some API results to a public google sheet. Google OAUTH client credentials are a prerequisite for this method to work correctly. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        title: str, optional </span>
<span class="sd">            The spreadsheet title, if one wants to reuse an existing spreadsheet.</span>
<span class="sd">        verbose: bool, default=True</span>
<span class="sd">            Verbose mode</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method assumes that the calling environment can provide valid Google authentication credentials.</span>
<span class="sd">        There are two routes to make this work, depending on whether one is using Google Colab or a traditional Jupyter environment.</span>

<span class="sd">        **Google Colab**</span>
<span class="sd">        This is the easiest route. In Google Colab, all required libraries are already available. The `to_gsheets` method simply triggers the built-in authentication process via a pop up window. </span>
<span class="sd">        </span>
<span class="sd">        **Jupyter**</span>
<span class="sd">        This route involves a few more steps. In Jupyter, it is necessary to install the gspread, oauth2client and gspread_dataframe modules first. Secondly, one needs to create Google Drive access credentials using OAUTH (which boils down to a JSON file). Note that the credentials file needs to be saved in: `~/.config/gspread/credentials.json` (for gpread). </span>
<span class="sd">        The steps are described at https://gspread.readthedocs.io/en/latest/oauth2.html#for-end-users-using-oauth-client-id.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The google sheet URL as a string.   </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_dataframe</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">export_as_gsheets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>        </div>
             
    

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;dimcli.DslDataset object #</span><span class="si">%s</span><span class="s2">. Errors: </span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;dimcli.DslDataset object #</span><span class="si">%s</span><span class="s2">. Records: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_total</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># non-search queries</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;dimcli.DslDataset object #</span><span class="si">%s</span><span class="s2">. Dict keys: </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">]))</span></div>





<span class="c1"># 2019-12-17: for backward compatibility</span>
<span class="c1"># remove once all notebooks code has been updated </span>
<span class="n">Result</span> <span class="o">=</span> <span class="n">DslDataset</span>
<span class="n">Dataset</span> <span class="o">=</span> <span class="n">DslDataset</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, Digital Science.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>